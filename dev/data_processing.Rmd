---
title: "Data Processing Logic"
author: "Chiara Folland"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "/Users/00104561/Library/CloudStorage/OneDrive-UWA/Research/Projects/AIM3_TRANSCRIPTOMICS/app/rnawebapp")
library(dplyr)
library(ggplot2)
library(annotables)
library(OUTRIDER)
library(FRASER)
library(biomaRt)
library(org.Hs.eg.db)
```

Load datasets

```{r load-data, message=FALSE}
samplesheet <- read.table("./data/samplesheet.tsv", header=TRUE)
ods <- readRDS("./data/ods.Rds")
fds <- readRDS("./data/fds-object.RDS")
```

Define function to fix gene names in ods

```{r fix-names, message=FALSE}
#' Annotate Ensembl IDs with HGNC symbols
#'
#' @param se A SummarizedExperiment or DESeqDataSet object
#' @param annotation A data frame containing `ensgene` and `symbol` columns (default: annotables::grch38)
#'
#' @return A modified object with ENSG IDs and HGNC rownames where available
#' @export
#'
#' @importFrom SummarizedExperiment mcols
#' @importFrom data.table data.table
annotate_ensembl_ids <- function(se, annotation = annotables::grch38) {
  if (is.null(rownames(se))) {
    stop("Input object must have rownames containing Ensembl IDs.")
  }

  # Strip versioning from Ensembl IDs (e.g. ENSG000001.1 -> ENSG000001)
  geneIDs <- gsub("\\.[0-9]*(_[0-9]*)?.*$", "", rownames(se))

  # Merge with annotation
  merged_annot <- merge(
    data.table(ensgene = geneIDs),
    annotation,
    sort = FALSE,
    all.x = TRUE
  )[!duplicated(ensgene), ]

  # Set gene IDs
  if (!"geneID" %in% colnames(SummarizedExperiment::mcols(se))) {
    SummarizedExperiment::mcols(se)$ENSG <- geneIDs

    # Replace rownames where possible
    new_names <- ifelse(
      is.na(merged_annot$symbol) |
        merged_annot$symbol == "" |
        duplicated(merged_annot$symbol),
      geneIDs,
      merged_annot$symbol
    )

    rownames(se) <- new_names
  }

  return(se)
}

# change gene names

ods_hgnc <- annotate_ensembl_ids(ods)

```

Fix the FRASER results directory

FRASER tracks a bunch of internal model outputs (psi3, psi5, zScore, theta, padjBetaBinomial_theta, etc.) in the fds object.
If the `.fds` object was computed externally, the paths to the outputs will be wrongly specified. This needs to be corrected and follow a proper file hierarchy. 

In particular, .h5 files must be in a nested `savedObjects/MUSCLE--v38` directory within the `workingDir`

```{r fraser, message=FALSE}
#' Fix the FRASER results directory
#'
#' @param fds A FRASER dataset 
#' @param base_path The path to the directory containing the `.h5` objects (default: "./data/savedObjects/MUSCLE--v38/")
#' @param working_dir The path to the working directory
#' @return A modified object with appropriate h5 paths
#' @export
#'
fixFdsH5Paths <- function(fds,
                          base_path = "./data/savedObjects/MUSCLE--v38/",
                          working_dir = "./data/",
                          verbose = FALSE) {
  fds@workingDir <- working_dir
  
  # Fix spliced assays
  for (assay_name in names(fds@assays@data@listData)) {
    h5_path <- file.path(base_path, paste0(assay_name, ".h5"))
    fds@assays@data@listData[[assay_name]]@seed@seed@filepath <- h5_path
    if (verbose) message("âœ”ï¸ Spliced assay ", assay_name, ": ", h5_path)
  }
  
  # Fix non-spliced assays
  for (assay_name in names(fds@nonSplicedReads@assays@data@listData)) {
    h5_path <- file.path(base_path, paste0(assay_name, ".h5"))
    fds@nonSplicedReads@assays@data@listData[[assay_name]]@seed@seed@filepath <- h5_path
    if (verbose) message("âœ”ï¸ Non-spliced assay ", assay_name, ": ", h5_path)
  }
  
  return(fds)
}

#fix the paths in the fds object
fds <- fixFdsH5Paths(fds)

```

Generate and format results tables
```{R results, message=FALSE}
#' Generate OUTRIDER and FRASER results with optional padjust filtering
#'
#' @param fds A FRASER dataset 
#' @param ods An OUTRIDER dataset 
#' @param padj_threshold Optional adjusted p-value threshold for filtering (default = 0.05)
#' @param merged select to return a dataframe containing the samples and genes in both FRASER and OUTRIDER
#' 
#' @return list containing OUTRIDER and FRASER result tables
#' @export
#'
#' @importFrom dplyr select rename transmute filter
#' @importFrom OUTRIDER results
#' @importFrom FRASER results
generate_results <- function(ods, fds, padj_threshold = 0.05, merged = TRUE) {
  outres<-as.data.frame(OUTRIDER::results(ods, padjCutoff=padj_threshold))
  frares<-as.data.frame(FRASER::results(fds, padjCutoff=padj_threshold))
  
  frares <- frares %>%
  dplyr::rename(geneID = hgncSymbol) %>%
  transmute(sampleID, geneID,   
            coord = paste(seqnames, start, end, sep = ":"),
            type, strand, padjust, psiValue, deltaPsi, counts, totalCounts, meanCounts, meanTotalCounts, annotatedJunction)
  outres <- outres %>%
  dplyr::select(sampleID, geneID, padjust, everything())
  
  merged <- merge(frares, outres, by.x=c("geneID","sampleID"), by.y=c("geneID","sampleID"), suffixes = c(".fra",".out")) %>%
    dplyr::select(geneID:sampleID) %>% unique()
  
  return(list(outres = outres, frares = frares, merged = merged))
  
}

# Generate results tables

results <- generate_results(ods_hgnc, fds)

```

Create function for generating a sample and data summary table
```{R summary, message=FALSE}
#' Generate a table summarising available data and samples
#'
#' @param fds A FRASER dataset 
#' @param ods An OUTRIDER dataset 
#'
#' @return data.frame with which data is available for each sample
#' @export
#'
#' @importFrom dplyr select rename transmute filter
#' @importFrom OUTRIDER results
#' @importFrom FRASER results
summarise_data <- function(ods, fds) {
  # Retrieve sample names
  ods_samples <- colnames(ods)
  fds_samples <- colnames(fds)
  
  # Get list of all unique samples
  all_samples <- sort(unique(c(ods_samples, fds_samples)))
  
  # Merge into one data frame
  sample_status <- data.frame(
    sampleID = all_samples,
    OUTRIDER = all_samples %in% ods_samples,
    FRASER = all_samples %in% fds_samples,
    stringsAsFactors = FALSE
  )
  
  return(sample_status)
}

summarise_data(ods, fds)

```

Add in OMIM and GO
```{R summary, message=FALSE}

## Retrieve OMIM data

annotate_results_with_omim_go <- function(results,
                                          geneIDs,
                                          add_omim = TRUE,
                                          omim_file = "./data/omim-phenotype.txt",
                                          add_go = TRUE,
                                          go_source = "ensembl") {
  #Load packages
  
  library(dplyr)
  library(biomaRt)
  library(org.Hs.eg.db)
  
  # Start with the original results
  annotated <- results
  
  # ----- OMIM ANNOTATION -----
  if (add_omim) {
    message("ðŸ” Annotating with OMIM...")
    
    phe <- read.table(omim_file, header = TRUE, fill = TRUE)
    colnames(phe)[1] <- "OMIM"
    
    cols <- c("SYMBOL", "GENENAME", "OMIM")
    omim <- select(org.Hs.eg.db, keys = geneIDs, columns = cols, keytype = "ENSEMBL")
    colnames(omim)[1] <- "ensembl"
    
    mim_phe <- merge(omim, phe, by = "OMIM", all.x = TRUE)
    
    sum_ens <- mim_phe %>%
      group_by(SYMBOL) %>%
      summarise(Phenotypes = paste(unique(Phenotypes), collapse = "; "), .groups = "drop")
    
    annotated <- merge(annotated, sum_ens, by.x = "geneID", by.y = "SYMBOL", all.x = TRUE)
  }
  
  # ----- GO TERM ANNOTATION -----
  if (add_go) {
    message("ðŸ” Annotating with GO terms via BioMart...")
    
    mart <- useMart(go_source, dataset = "hsapiens_gene_ensembl")
    go_terms <- getBM(
      mart = mart,
      attributes = c("hgnc_symbol", "go_id", "namespace_1003", "name_1006"),
      filters = "hgnc_symbol",
      values = annotated$geneID
    )
    
    go_terms <- go_terms[!duplicated(go_terms), ]
    go_terms <- go_terms[!(is.na(go_terms$name_1006) | go_terms$name_1006 == ""), ]
    
    go <- go_terms %>%
      group_by(hgnc_symbol) %>%
      summarise(GO_TERMS = paste(unique(name_1006), collapse = " | "), .groups = "drop")
    
    annotated <- merge(annotated, go, by.x = "geneID", by.y = "hgnc_symbol", all.x = TRUE)
  }
  
  # Sort by padjust (if present)
  if ("padjust" %in% colnames(annotated)) {
    annotated <- annotated[order(annotated$padjust), ]
  }
  
  return(annotated)
}

# Assume frares has a column geneID (HGNC symbol) and you have ENSEMBL gene IDs
fres_annotated <- annotate_results_with_omim_go(
  results = results$frares,
  geneIDs = geneIDs,   # vector of ENSEMBL IDs
  add_omim = TRUE,
  add_go = TRUE
)

# OUTRIDER example (with same gene list)
ores_annotated <- annotate_results_with_omim_go(
  results = results$outres,
  geneIDs = geneIDs,
  add_omim = TRUE,
  add_go = TRUE
)

```
